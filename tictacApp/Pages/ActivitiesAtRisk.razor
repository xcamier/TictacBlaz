@page "/activitiesatrisk"

@using tictacApp.Data
@using tictacApp.Interfaces
@using tictacApp.ViewModels
@using AutoMapper

@inject IPlannedActivityCRUDService PlannedActivitiesService
@inject ISettingsService SettingsService
@inject IMapper Mapper
@inject NavigationManager Navigation

<ActivitiesAtRiskComponent
        PageTitle="Activities at risk"
        ActivitiesSettings=@_activitiesSettings
        Projects=@_projects
        Objectives=@_objectives
        PlannedActivitiesWithChildren=@_projectsWithChildren
        Loading=@_loading
        Error=@_error
        ErrorMessage=@_errorMessage
        GoToActivityInListAsync="@((activityToSelect) => NavigateToList(activityToSelect))"
        OnFilterChangedAsync="@(async (selectedValue) => await Refresh(selectedValue))">
</ActivitiesAtRiskComponent>


@code {
    private PlannedActivitySettingsView _activitiesSettings;
    private PlannedActivityView[] _projects;
    private PlannedActivityView[] _objectives;
    private IEnumerable<int> _projectsWithChildren;
    private IEnumerable<int> _objectivesWithChildren;

    private bool _loading = false;
    private bool _error = false;
    private string _errorMessage = string.Empty;


    protected override async Task OnInitializedAsync()
    {
        await Refresh(1);

        await base.OnInitializedAsync();
    }

    private async Task Refresh(int numberOfDays)
    {
        ResetErrorMessage();

        try
        {
            await GetSettings();
            await GetPlannedActivitiesExpectedAsync(numberOfDays);
            await GetPlannedActivitiesChildrenAsync();
        }
        catch (Exception ex)
        {
            _error = true;
            _errorMessage = $"Error when loading the data: {ex.Message}"; 
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task GetSettings()
    {
        Setting[] settings = await SettingsService.GetAllAsync();
        _activitiesSettings = SettingsService.MapPlannedActivitySettingsToView(settings);
    }

    private async Task GetPlannedActivitiesExpectedAsync(int numberOfDays)
    {   
        DateTime targetDate = DateTime.Now.AddDays(numberOfDays);
        var projects = await PlannedActivitiesService.GetAllAsync<Project>(targetDate);
        var objectives = await PlannedActivitiesService.GetAllAsync<Objective>(targetDate);
        
        _projects = Mapper.Map<PlannedActivityView[]>(projects);
        _objectives = Mapper.Map<PlannedActivityView[]>(objectives);
    }

    private async Task GetPlannedActivitiesChildrenAsync()
    {
        int[] projectIds = _projects.Select(p => p.Id).ToArray();
        int[] objectiveIds = _objectives.Select(o => o.Id).ToArray();

        _projectsWithChildren = 
                            await PlannedActivitiesService.GetIdOfPlannedActivitiesWithChildren<Project>(projectIds);
        _objectivesWithChildren = 
                            await PlannedActivitiesService.GetIdOfPlannedActivitiesWithChildren<Objective>(objectiveIds);
    }

    private void NavigateToList(PlannedActivityView activity)
    {
        string listType = (_projects.Any(p => p.Id == activity.Id)) ? "projects" : "objectives";
        string uri = $"/{listType}";
        
        if (activity.ParentId.HasValue)
        {
            uri = $"{uri}/{activity.ParentId.Value}";
        } 

        Navigation.NavigateTo(uri);
    }

    private void ResetErrorMessage()
    {
        _error = false;
        _errorMessage = string.Empty;
    }
}


