@using tictacApp.Data
@using tictacApp.Helpers
@using tictacApp.Validators

<MudForm Model="@Objective"
    @ref="@_form" Validation="@(_validator.ValidateValue)" ValidationDelay="0">

    <MudGrid Justify="Justify.Center" Class="mt-2">
        <MudItem xs="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">@_mode Objective</MudText>
                    </CardHeaderContent>
                </MudCardHeader>

                @if (Objective is not null)
                {
                    <MudCardContent>  
                        <MudTextField T="string" Label="Label" Variant="Variant.Text" 
                                        @bind-Value="Objective.Label" For="@(() => Objective.Label)" 
                                        Immediate="true"/>

                        <MudTextField T="string" Label="Description" Variant="Variant.Text" Lines="3" 
                                        @bind-Value="Objective.Description" For="@(() => Objective.Description)" 
                                        Immediate="true"/>

                        <MudDatePicker Label="Target date" Placeholder="Select Date"
                                    Editable="true" DisableToolbar="true"
                                    @bind-Date="Objective.TargetDate" For="@(() => Objective.TargetDate)" />

                        <MudGrid Class="mt-4">
                            <MudItem xs="6">
                                <MudSwitch  Label="Finalized" Color="Color.Info" 
                                            @bind-Checked="@Objective.IsFinalized" For="@(() => Objective.IsFinalized)"/>
                            </MudItem>
                            <MudItem xs="6">
                                <MudDatePicker Label="Finalization date" Placeholder="Select Date"
                                            Editable="true" DisableToolbar="true"
                                            @bind-Date="Objective.FinalizationDate" For="@(() => Objective.FinalizationDate)" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudSwitch  Label="Closed" Color="Color.Info" 
                                            @bind-Checked="@Objective.IsClosed" For="@(() => Objective.IsClosed)"/>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                    <MudCardActions Class="d-flex justify-space-between">                                
                        <MudButton Variant="Variant.Filled" Disabled="@Busy" 
                                    Color="Color.Primary" 
                                    OnClick="@(async () => await HandleSubmitAsync(true))">@_mode</MudButton>
                        
                        <MudButton Variant="Variant.Filled" Disabled="@Busy" 
                                    Color="Color.Primary" 
                                    OnClick="@(async () => await CancelAsync())">Cancel</MudButton>
                    </MudCardActions>
                }
            </MudCard>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
    [Parameter]
    public EventCallback<bool> ValidationResult { get; set; }

    [Parameter]
    public EventCallback CancelRequest { get; set; }

    [Parameter]
    public bool IsAdd { get; set; }

    [Parameter]
    public Objective? Objective { get; set; }

    [Parameter]
    public bool Busy { get; set; }

    private string _mode => IsAdd ? "Add" : "Edit";
    private MudForm _form;

    private LabelAndDescriptionFluentValidator<Objective> _validator = 
                new LabelAndDescriptionFluentValidator<Objective>(Constants.LabelMinLength, 
                                                                    Constants.LabelLongLength, 
                                                                    Constants.DescriptionStandardLength);

    private Task CancelAsync()
    {
        return CancelRequest.InvokeAsync(null);
    }

    private async Task<Task> HandleSubmitAsync(bool isValid)
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            return ValidationResult.InvokeAsync(true);
        }

        return ValidationResult.InvokeAsync(false);
    }
}